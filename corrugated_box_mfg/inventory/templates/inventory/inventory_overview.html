{% extends 'base.html' %}

{% block title %}Inventory Overview{% endblock %}

{% block content %}
{% csrf_token %}
{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}
<div class="mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1 class="display-5 mb-1">Inventory Overview</h1>
        <p class="text-muted">Current stock levels and inventory status</p>
    </div>
    <a href="{% url 'add_inventory' %}" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle"></i> Add Inventory
    </a>
</div>

<div class="row g-4">
    <!-- Paper Reels Card -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="bi bi-box"></i> Paper Reels</h3>
                <button class="btn btn-sm btn-light" onclick="exportTable('paper-reels-table')">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="paper-reels-table">
                        <thead class="table-light">
                            <tr>
                                <th>GSM</th>
                                <th>BF</th>
                                <th>Size</th>
                                <th>Weight (Kg)</th>
                                <th>Company</th>
                                <th>Price/Kg</th>
                                <th>Freight</th>
                                <th>Extra</th>
                                <th>Ex Tax</th>
                                <th>Tax %</th>
                                <th>Tax Amt</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reel in paper_reels %}
                            <tr data-id="{{ reel.id }}">
                                <td>{{ reel.gsm }}</td>
                                <td>{{ reel.bf }}</td>
                                <td>{{ reel.size }}</td>
                                <td>{{ reel.total_weight }}</td>
                                <td>{{ reel.company_name }}</td>
                                <td>{{ reel.price_per_kg }}</td>
                                <td>{{ reel.freight }}</td>
                                <td>{{ reel.extra_charges }}</td>
                                <td>{{ reel.total_price_ex_tax }}</td>
                                <td>{{ reel.tax_percent }}%</td>
                                <td>{{ reel.tax_amount }}</td>
                                <td>{{ reel.total_price }}</td>
                                <td>{{ reel.timestamp|date:"d-m-Y" }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('paper_reels', {{ reel.id }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('paper_reels', {{ reel.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pasting Gum Card -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="bi bi-droplet"></i> Pasting Gum</h3>
                <button class="btn btn-sm btn-light" onclick="exportTable('gum-table')">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="gum-table">
                        <thead class="table-light">
                            <tr>
                                <th>Type</th>
                                <th>Weight/Bag</th>
                                <th>Quantity</th>
                                <th>Company</th>
                                <th>Price/Kg</th>
                                <th>Freight</th>
                                <th>Extra</th>
                                <th>Ex Tax</th>
                                <th>Tax %</th>
                                <th>Tax Amt</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for gum in pasting_gum %}
                            <tr data-id="{{ gum.id }}">
                                <td>{{ gum.gum_type }}</td>
                                <td>{{ gum.weight_per_bag }}</td>
                                <td>{{ gum.total_qty }}</td>
                                <td>{{ gum.company_name }}</td>
                                <td>{{ gum.price_per_kg }}</td>
                                <td>{{ gum.freight }}</td>
                                <td>{{ gum.extra_charges }}</td>
                                <td>{{ gum.total_price_ex_tax }}</td>
                                <td>{{ gum.tax_percent }}%</td>
                                <td>{{ gum.tax_amount }}</td>
                                <td>{{ gum.total_price }}</td>
                                <td>{{ gum.timestamp|date:"d-m-Y" }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('pasting_gum', {{ gum.id }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('pasting_gum', {{ gum.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Ink Stock Card -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="bi bi-palette"></i> Ink Stock</h3>
                <button class="btn btn-sm btn-light" onclick="exportTable('ink-table')">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="ink-table">
                        <thead class="table-light">
                            <tr>
                                <th>Color</th>
                                <th>Weight/Can</th>
                                <th>Quantity</th>
                                <th>Company</th>
                                <th>Price/Kg</th>
                                <th>Freight</th>
                                <th>Extra</th>
                                <th>Ex Tax</th>
                                <th>Tax %</th>
                                <th>Tax Amt</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ink in ink_stock %}
                            <tr data-id="{{ ink.id }}">
                                <td>{{ ink.color }}</td>
                                <td>{{ ink.weight_per_can }}</td>
                                <td>{{ ink.total_qty }}</td>
                                <td>{{ ink.company_name }}</td>
                                <td>{{ ink.price_per_kg }}</td>
                                <td>{{ ink.freight }}</td>
                                <td>{{ ink.extra_charges }}</td>
                                <td>{{ ink.total_price_ex_tax }}</td>
                                <td>{{ ink.tax_percent }}%</td>
                                <td>{{ ink.tax_amount }}</td>
                                <td>{{ ink.total_price }}</td>
                                <td>{{ ink.timestamp|date:"d-m-Y" }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('ink_stock', {{ink.id}})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('ink_stock', {{ ink.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Strapping Roll Card -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="bi bi-circle"></i> Strapping Roll</h3>
                <button class="btn btn-sm btn-light" onclick="exportTable('strapping-table')">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="strapping-table">
                        <thead class="table-light">
                            <tr>
                                <th>Type</th>
                                <th>Meters/Roll</th>
                                <th>Weight/Roll</th>
                                <th>Quantity</th>
                                <th>Company</th>
                                <th>Price/Kg</th>
                                <th>Freight</th>
                                <th>Extra</th>
                                <th>Ex Tax</th>
                                <th>Tax %</th>
                                <th>Tax Amt</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for roll in strapping_rolls %}
                            <tr data-id="{{ roll.id }}">
                                <td>{{ roll.roll_type }}</td>
                                <td>{{ roll.meters_per_roll }}</td>
                                <td>{{ roll.weight_per_roll }}</td>
                                <td>{{ roll.total_qty }}</td>
                                <td>{{ roll.company_name }}</td>
                                <td>{{ roll.price_per_kg }}</td>
                                <td>{{ roll.freight }}</td>
                                <td>{{ roll.extra_charges }}</td>
                                <td>{{ roll.total_price_ex_tax }}</td>
                                <td>{{ roll.tax_percent }}%</td>
                                <td>{{ roll.tax_amount }}</td>
                                <td>{{ roll.total_price }}</td>
                                <td>{{ roll.timestamp|date:"d-m-Y" }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('strapping_rolls', {{ roll.id }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('strapping_rolls', {{ roll.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Pin Coil Card -->
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0"><i class="bi bi-pin"></i> Pin Coil</h3>
                <button class="btn btn-sm btn-light" onclick="exportTable('pincoil-table')">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="pincoil-table">
                        <thead class="table-light">
                            <tr>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Company</th>
                                <th>Price/Kg</th>
                                <th>Freight</th>
                                <th>Extra</th>
                                <th>Ex Tax</th>
                                <th>Tax %</th>
                                <th>Tax Amt</th>
                                <th>Total</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for coil in pin_coils %}
                            <tr data-id="{{ coil.id }}">
                                <td>{{ coil.coil_type }}</td>
                                <td>{{ coil.total_qty }}</td>
                                <td>{{ coil.company_name }}</td>
                                <td>{{ coil.price_per_kg }}</td>
                                <td>{{ coil.freight }}</td>
                                <td>{{ coil.extra_charges }}</td>
                                <td>{{ coil.total_price_ex_tax }}</td>
                                <td>{{ coil.tax_percent }}%</td>
                                <td>{{ coil.tax_amount }}</td>
                                <td>{{ coil.total_price }}</td>
                                <td>{{ coil.timestamp|date:"d-m-Y" }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editItem('pin_coils', {{ coil.id }})">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('pin_coils', {{ coil.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
function exportTable(tableId) {
    const table = document.getElementById(tableId);
    const rows = table.getElementsByTagName('tr');
    let csv = [];
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cols = row.querySelectorAll('td, th');
        let csvRow = [];
        
        for (let j = 0; j < cols.length - 1; j++) { // Skip the Actions column
            csvRow.push(cols[j].innerText);
        }
        
        csv.push(csvRow.join(','));
    }

    const csvContent = 'data:text/csv;charset=utf-8,' + csv.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', `${tableId}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Delete functionality
function deleteItem(modelName, itemId) {
    if (confirm('Are you sure you want to delete this item?')) {
        fetch(`/inventory/delete/${modelName}/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Remove the row from the table
                const row = document.querySelector(`tr[data-id="${itemId}"]`);
                if (row) {
                    row.remove();
                } else {
                    location.reload();
                }
            } else {
                alert('Error deleting item: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting item');
        });
    }
}

// Edit functionality
function editItem(modelName, itemId) {
    fetch(`/inventory/edit/${modelName}/${itemId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showEditModal(modelName, itemId, data.data);
            } else {
                alert('Error loading item data: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading item data');
        });
}

function showEditModal(modelName, itemId, data) {
    // Remove any existing modal
    const existingModal = document.getElementById('editModal');
    if (existingModal) {
        existingModal.remove();
    }

    const modalHtml = createModalHtml(modelName, data);
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    const modal = new bootstrap.Modal(document.getElementById('editModal'));
    modal.show();
    
    document.getElementById('editForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        fetch(`/inventory/edit/${modelName}/${itemId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                modal.hide();
                location.reload();
            } else {
                alert('Error updating item: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating item');
        });
    });
}

function createModalHtml(modelName, data) {
    let fieldsHtml = '';
    
    // Common fields first
    fieldsHtml += createInputField('company_name', data.company_name, 'Company Name');
    fieldsHtml += createInputField('price_per_kg', data.price_per_kg, 'Price per Kg', 'number', '0.01');
    fieldsHtml += createInputField('freight', data.freight, 'Freight', 'number', '0.01');
    fieldsHtml += createInputField('extra_charges', data.extra_charges, 'Extra Charges', 'number', '0.01');
    fieldsHtml += createInputField('tax_percent', data.tax_percent, 'Tax Percentage', 'number', '0.01');
    
    // Model-specific fields
    switch(modelName) {
        case 'paper_reels':
            fieldsHtml += createInputField('gsm', data.gsm, 'GSM', 'number');
            fieldsHtml += createInputField('bf', data.bf, 'BF');
            fieldsHtml += createInputField('size', data.size, 'Size');
            fieldsHtml += createInputField('total_weight', data.total_weight, 'Total Weight', 'number', '0.01');
            break;
        case 'pasting_gum':
            fieldsHtml += createInputField('gum_type', data.gum_type, 'Gum Type');
            fieldsHtml += createInputField('weight_per_bag', data.weight_per_bag, 'Weight per Bag', 'number', '0.01');
            fieldsHtml += createInputField('total_qty', data.total_qty, 'Total Quantity', 'number');
            break;
        // ... add other cases for different models
    }
    
    return `
        <div class="modal fade" id="editModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit ${modelName.replace(/_/g, ' ').toUpperCase()}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="row">
                                ${fieldsHtml}
                            </div>
                            <div class="mt-3">
                                <button type="submit" class="btn btn-primary">Save changes</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function createInputField(name, value, label, type = 'text', step = null) {
    return `
        <div class="col-md-6 mb-3">
            <label for="${name}" class="form-label">${label}</label>
            <input type="${type}" 
                   class="form-control" 
                   id="${name}" 
                   name="${name}" 
                   value="${value || ''}"
                   ${step ? `step="${step}"` : ''}
                   required>
        </div>
    `;
}
</script>
{% endblock %}
{% endblock %}
