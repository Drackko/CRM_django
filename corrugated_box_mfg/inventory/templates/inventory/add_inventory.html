{% extends 'base.html' %}

{% block title %}Add Inventory - Box Manufacturing{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="display-5">Add Inventory</h1>
    <p class="text-muted">Add new items to your inventory</p>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <form method="POST" action="{% url 'add_inventory' %}" id="inventoryForm">
            {% csrf_token %}
            
            <!-- Common Fields -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="item_type" class="form-label">Item Type</label>
                        <select class="form-select" id="item_type" name="item_type" required onchange="showItemForm()">
                            <option value="">Select Item Type</option>
                            <option value="Paper Reel">Paper Reel</option>
                            <option value="Pasting Gum">Pasting Gum</option>
                            <option value="Ink">Ink</option>
                            <option value="Strapping Roll">Strapping Roll</option>
                            <option value="Pin Coil">Pin Coil</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Dynamic Form Section -->
            <div id="dynamicFormFields"></div>

            <!-- Common Fields (Initially Hidden) -->
            <div id="commonFields" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="company_name" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="company_name" name="company_name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="price_per_kg" class="form-label">Price per Kg</label>
                            <input type="number" step="0.01" class="form-control" id="price_per_kg" name="price_per_kg" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="freight" class="form-label">Freight Charges</label>
                            <input type="number" step="0.01" class="form-control" id="freight" name="freight" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="extra_charges" class="form-label">Extra Charges</label>
                            <input type="number" step="0.01" class="form-control" id="extra_charges" name="extra_charges" required>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="tax_percent" class="form-label">Tax Percentage</label>
                            <input type="number" step="0.01" class="form-control" id="tax_percent" name="tax_percent" required>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Price Ex Tax</h6>
                                <p class="card-text h4" id="totalPriceExTax">₹0.00</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Tax Amount</h6>
                                <p class="card-text h4" id="taxAmount">₹0.00</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Total Amount</h6>
                                <p class="card-text h4" id="totalAmount">₹0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Item
                </button>
            </div>
        </form>
    </div>
</div>

{% if messages %}
<div class="mt-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
const formTemplates = {
    'Paper Reel': `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="gsm" class="form-label">GSM</label>
                    <input type="number" class="form-control" id="gsm" name="gsm" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="bf" class="form-label">BF</label>
                    <input type="text" class="form-control" id="bf" name="bf">
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="size" class="form-label">Size</label>
                    <input type="text" class="form-control" id="size" name="size" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="total_weight" class="form-label">Total Weight (Kg)</label>
                    <input type="number" step="0.01" class="form-control" id="total_weight" name="total_weight" required>
                </div>
            </div>
        </div>
    `,
    'Pasting Gum': `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="gum_type" class="form-label">Gum Type</label>
                    <input type="text" class="form-control" id="gum_type" name="gum_type" required>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="weight_per_bag" class="form-label">Weight per Bag (Kg)</label>
                    <input type="number" step="0.01" class="form-control" id="weight_per_bag" name="weight_per_bag" required>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="total_qty" class="form-label">Total Quantity</label>
                    <input type="number" class="form-control" id="total_qty" name="total_qty" required>
                </div>
            </div>
        </div>
    `,
    'Ink': `
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="color" class="form-label">Color</label>
                    <input type="text" class="form-control" id="color" name="color" required>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="weight_per_can" class="form-label">Weight per Can (Kg)</label>
                    <input type="number" step="0.01" class="form-control" id="weight_per_can" name="weight_per_can" required>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="total_qty" class="form-label">Total Quantity</label>
                    <input type="number" class="form-control" id="total_qty" name="total_qty" required>
                </div>
            </div>
        </div>
    `,
    'Strapping Roll': `
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="roll_type" class="form-label">Roll Type</label>
                    <input type="text" class="form-control" id="roll_type" name="roll_type" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="meters_per_roll" class="form-label">Meters per Roll</label>
                    <input type="number" class="form-control" id="meters_per_roll" name="meters_per_roll" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="weight_per_roll" class="form-label">Weight per Roll (Kg)</label>
                    <input type="number" step="0.01" class="form-control" id="weight_per_roll" name="weight_per_roll" required>
                </div>
            </div>
            <div class="col-md-3">
                <div class="mb-3">
                    <label for="total_qty" class="form-label">Total Quantity</label>
                    <input type="number" class="form-control" id="total_qty" name="total_qty" required>
                </div>
            </div>
        </div>
    `,
    'Pin Coil': `
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="coil_type" class="form-label">Coil Type</label>
                    <input type="text" class="form-control" id="coil_type" name="coil_type" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="total_qty" class="form-label">Total Quantity</label>
                    <input type="number" class="form-control" id="total_qty" name="total_qty" required>
                </div>
            </div>
        </div>
    `
};

function calculateTotals() {
    const itemType = document.getElementById('item_type').value;
    const pricePerKg = parseFloat(document.getElementById('price_per_kg').value) || 0;
    const freight = parseFloat(document.getElementById('freight').value) || 0;
    const extraCharges = parseFloat(document.getElementById('extra_charges').value) || 0;
    const taxPercent = parseFloat(document.getElementById('tax_percent').value) || 0;
    
    let quantity = 0;
    
    // Get quantity based on item type
    if (itemType === 'Paper Reel') {
        quantity = parseFloat(document.getElementById('total_weight')?.value) || 0;
    } else {
        const totalQty = document.getElementById('total_qty')?.value || 0;
        const weightPerUnit = parseFloat(
            document.getElementById('weight_per_bag')?.value || 
            document.getElementById('weight_per_can')?.value || 
            document.getElementById('weight_per_roll')?.value || 
            0
        );
        quantity = totalQty * weightPerUnit;
    }

    // Calculate totals
    const totalPriceExTax = (pricePerKg * quantity) + freight + extraCharges;
    const taxAmount = (totalPriceExTax * taxPercent) / 100;
    const totalAmount = totalPriceExTax + taxAmount;

    // Update display
    document.getElementById('totalPriceExTax').textContent = `₹${totalPriceExTax.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `₹${taxAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `₹${totalAmount.toFixed(2)}`;
}

// Add event listeners to all input fields
function addCalculationListeners() {
    const inputs = document.querySelectorAll('input[type="number"]');
    inputs.forEach(input => {
        input.addEventListener('input', calculateTotals);
    });
}

function showItemForm() {
    const itemType = document.getElementById('item_type').value;
    const dynamicFormFields = document.getElementById('dynamicFormFields');
    const commonFields = document.getElementById('commonFields');
    
    if (itemType) {
        dynamicFormFields.innerHTML = formTemplates[itemType] || '';
        commonFields.style.display = 'block';
        addCalculationListeners(); // Add listeners after form is populated
    } else {
        dynamicFormFields.innerHTML = '';
        commonFields.style.display = 'none';
    }
}

// Add listeners to common fields
document.addEventListener('DOMContentLoaded', function() {
    const commonInputs = document.querySelectorAll('#commonFields input[type="number"]');
    commonInputs.forEach(input => {
        input.addEventListener('input', calculateTotals);
    });
});
</script>
{% endblock %}
